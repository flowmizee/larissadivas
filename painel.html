<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Vendas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
  <style>
    :root { --primary:#4361ee; --secondary:#3f37c9; --success:#4cc9f0; --danger:#f72585; --light:#f8f9fa; --dark:#212529; }
    body { font-family:'Segoe UI',sans-serif; background:#f5f7fa; margin:0; color:#333; }
    .dashboard { display:grid; grid-template-columns:250px 1fr; min-height:100vh; }
    .sidebar { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; padding:20px; box-shadow:2px 0 10px rgba(0,0,0,0.1); }
    .logo { font-size:1.5rem; font-weight:bold; margin-bottom:30px; display:flex; align-items:center; gap:10px; }
    .nav-menu { list-style:none; padding:0; }
    .nav-menu li { margin-bottom:15px; }
    .nav-menu a { color:white; text-decoration:none; display:flex; align-items:center; gap:10px; padding:10px; border-radius:5px; transition:all .3s; }
    .nav-menu a:hover, .nav-menu a.active { background:rgba(255,255,255,0.2); }
    .main-content { padding:20px; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; }
    .page-title { font-size:1.8rem; font-weight:600; }
    .filters { display:flex; gap:15px; }
    .filter-group label { display:block; margin-bottom:5px; font-weight:500; font-size:.9rem; }
    select, input { padding:8px 15px; border-radius:5px; border:1px solid #ddd; background:white; }
    .cards-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px; margin-bottom:30px; }
    .card { background:white; border-radius:10px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); transition:transform .3s,box-shadow .3s; }
    .card:hover { transform:translateY(-5px); box-shadow:0 10px 15px rgba(0,0,0,0.1); }
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .card-title { font-size:1rem; color:#666; font-weight:500; }
    .card-icon { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; }
    .sales { background:var(--primary); } .orders { background:var(--danger); } .revenue { background:#ff9f1c; } .clients { background:var(--success); }
    .card-value { font-size:1.8rem; font-weight:700; margin-bottom:5px; }
    .card-change { display:flex; align-items:center; font-size:.9rem; }
    .card-change.positive { color:#2ecc71; } .card-change.negative { color:#e74c3c; }
    .charts-container { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px; }
    .chart-card { background:white; border-radius:10px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
    .chart-title { font-size:1.2rem; margin-bottom:20px; font-weight:600; }
    .clients-table { background:white; border-radius:10px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px 15px; text-align:left; border-bottom:1px solid #eee; }
    th { font-weight:600; color:#555; } tr:hover { background:#f9f9f9; }
    .status-badge { padding:4px 8px; border-radius:12px; font-size:0.8rem; font-weight:500; }
    .status-completed { background:#e6f7ee; color:#2ecc71; }
    .status-pending { background:#fff8e6; color:#f39c12; }
    .status-canceled { background:#fee; color:#e74c3c; }
    .loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(0,0,0,.1); border-radius:50%; border-top-color:var(--primary); animation:spin 1s ease-in-out infinite; margin-left:10px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media(max-width:992px){ .dashboard{grid-template-columns:1fr;} .sidebar{display:none;} .charts-container{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="sidebar">
      <div class="logo"><i class="fas fa-chart-line"></i> SalesDash</div>
      <ul class="nav-menu">
        <li><a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="#"><i class="fas fa-users"></i> Clientes</a></li>
        <li><a href="#"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
        <li><a href="#"><i class="fas fa-box-open"></i> Produtos</a></li>
        <li><a href="#"><i class="fas fa-chart-pie"></i> Relatórios</a></li>
        <li><a href="#"><i class="fas fa-cog"></i> Configurações</a></li>
      </ul>
    </div>
    <div class="main-content">
      <div class="header">
        <h1 class="page-title">Dashboard de Vendas <span id="loading-indicator" class="loading" style="display:none;"></span></h1>
        <div class="filters">
          <div class="filter-group">
            <label for="date-range">Período</label>
            <input type="text" id="date-range" class="date-picker" placeholder="Selecione o período">
          </div>
          <div class="filter-group">
            <label for="status-filter">Status</label>
            <select id="status-filter">
              <option value="all">Todos</option>
              <option value="completed">Concluído</option>
              <option value="pending">Pendente</option>
              <option value="canceled">Cancelado</option>
            </select>
          </div>
        </div>
      </div>
      <div class="cards-container">
        <div class="card">
          <div class="card-header"><span class="card-title">Vendas Hoje</span><div class="card-icon sales"><i class="fas fa-dollar-sign"></i></div></div>
          <div id="vendas-hoje" class="card-value">R$ 0,00</div>
          <div id="change-hoje" class="card-change">—</div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Pedidos Hoje</span><div class="card-icon orders"><i class="fas fa-shopping-bag"></i></div></div>
          <div id="pedidos-hoje" class="card-value">0</div>
          <div id="change-pedidos" class="card-change">—</div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Produto Mais Vendido</span><div class="card-icon revenue"><i class="fas fa-chart-line"></i></div></div>
          <div id="mais-vendido" class="card-value">—</div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Receita Mensal</span><div class="card-icon clients"><i class="fas fa-calendar-alt"></i></div></div>
          <div id="receita-mes" class="card-value">R$ 0,00</div>
          <div id="change-mes" class="card-change">—</div>
        </div>
      </div>
      <div class="charts-container">
        <div class="chart-card"><h3 class="chart-title">Vendas Diárias (Últimos 7 dias)</h3><canvas id="dailySalesChart"></canvas></div>
        <div class="chart-card"><h3 class="chart-title">Vendas Mensais (Últimos 6 meses)</h3><canvas id="monthlySalesChart"></canvas></div>
      </div>
      <div class="clients-table">
        <h3 class="chart-title">Últimos Pedidos</h3>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Data</th>
              <th>Valor</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="ultimos-pedidos">
            <tr><td colspan="6" style="text-align:center;">Carregando dados...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // URL do seu Web App do Google Apps Script
    const API_URL = 'https://script.google.com/macros/s/AKfycbwTg9fJLlwPeHcguEPNKs5-goUipOhD1e2-90rhoUXbrHZHtKj9lROUImIHHLTfHNcV/exec';

    // Configuração inicial
    document.addEventListener('DOMContentLoaded', function() {
      // Configura o date picker
      flatpickr("#date-range", {
        mode: "range",
        dateFormat: "d/m/Y",
        defaultDate: [new Date().setDate(new Date().getDate()-7), new Date()],
        onChange: loadDashboardData
      });

      // Configura o filtro de status
      document.getElementById('status-filter').addEventListener('change', loadDashboardData);

      // Carrega os dados iniciais
      loadDashboardData();
    });

    // Funções auxiliares
    function formatMoney(value) {
      return new Intl.NumberFormat('pt-BR', { 
        style: 'currency', 
        currency: 'BRL' 
      }).format(value || 0);
    }

    function formatDate(dateString) {
      if (!dateString) return '—';
      try {
        return new Date(dateString).toLocaleDateString('pt-BR');
      } catch {
        return dateString;
      }
    }

    function renderVariation(value) {
      if (value === undefined || value === null) return '<span>—</span>';
      const isPositive = value >= 0;
      return `
        <span class="${isPositive ? 'positive' : 'negative'}">
          <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i> ${Math.abs(value)}%
        </span>
      `;
    }

    function getStatusBadge(status) {
      status = (status || '').toLowerCase();
      const classes = {
        'concluído': 'status-completed',
        'complete': 'status-completed',
        'pendente': 'status-pending',
        'pending': 'status-pending',
        'cancelado': 'status-canceled',
        'canceled': 'status-canceled'
      };
      return `<span class="status-badge ${classes[status] || ''}">${status || '—'}</span>`;
    }

    function showLoading(show) {
      document.getElementById('loading-indicator').style.display = show ? 'inline-block' : 'none';
    }

    // Função principal para carregar dados
    async function loadDashboardData() {
      try {
        showLoading(true);
        
        // Obtém os parâmetros dos filtros
        const dateRange = document.getElementById('date-range')._flatpickr.selectedDates;
        const statusFilter = document.getElementById('status-filter').value;
        
        // Prepara os parâmetros para a API
        const params = new URLSearchParams();
        
        if (dateRange.length === 2) {
          params.append('startDate', dateRange[0].toISOString().split('T')[0]);
          params.append('endDate', dateRange[1].toISOString().split('T')[0]);
        }
        
        if (statusFilter !== 'all') {
          params.append('status', statusFilter);
        }
        
        // Faz a requisição para seu Web App
        const response = await fetch(`${API_URL}?${params.toString()}`);
        
        if (!response.ok) {
          throw new Error(`Erro na requisição: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Atualiza a interface
        updateDashboard(data);
      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        showError();
      } finally {
        showLoading(false);
      }
    }

    function showError() {
      const tbody = document.getElementById('ultimos-pedidos');
      tbody.innerHTML = `
        <tr><td colspan="6" style="text-align:center;color:#e74c3c;">
          Erro ao carregar dados. Tente recarregar a página.
        </td></tr>
      `;
    }

    // Atualiza os elementos do dashboard
    function updateDashboard(data) {
      // Atualiza os cards
      document.getElementById('vendas-hoje').textContent = formatMoney(data.vendasHoje || 0);
      document.getElementById('pedidos-hoje').textContent = data.pedidosHoje || 0;
      document.getElementById('mais-vendido').textContent = data.produtoMaisVendido || '—';
      document.getElementById('receita-mes').textContent = formatMoney(data.receitaMensal || 0);
      
      // Atualiza as variações
      document.getElementById('change-hoje').innerHTML = renderVariation(data.variacaoVendas);
      document.getElementById('change-pedidos').innerHTML = renderVariation(data.variacaoPedidos);
      document.getElementById('change-mes').innerHTML = renderVariation(data.variacaoMensal);
      
      // Atualiza a tabela de pedidos
      const tbody = document.getElementById('ultimos-pedidos');
      tbody.innerHTML = '';
      
      if (data.ultimosPedidos && data.ultimosPedidos.length > 0) {
        data.ultimosPedidos.forEach(pedido => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${pedido.id || '—'}</td>
            <td>${pedido.cliente || '—'}</td>
            <td>${formatDate(pedido.data)}</td>
            <td>${formatMoney(pedido.valor)}</td>
            <td>${getStatusBadge(pedido.status)}</td>
            <td><button class="btn-details"><i class="fas fa-eye"></i></button></td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nenhum pedido encontrado</td></tr>';
      }
      
      // Atualiza os gráficos
      updateCharts(data.historicoVendas);
    }

    // Atualiza os gráficos
    function updateCharts(historico) {
      // Gráfico de vendas diárias
      const ctxDaily = document.getElementById('dailySalesChart').getContext('2d');
      if (window.dailyChart) window.dailyChart.destroy();
      
      window.dailyChart = new Chart(ctxDaily, {
        type: 'bar',
        data: {
          labels: historico?.diario?.map(item => formatDate(item.data)) || [],
          datasets: [{
            label: 'Vendas Diárias',
            data: historico?.diario?.map(item => item.total) || [],
            backgroundColor: '#4361ee'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatMoney(value);
                }
              }
            }
          }
        }
      });
      
      // Gráfico de vendas mensais
      const ctxMonthly = document.getElementById('monthlySalesChart').getContext('2d');
      if (window.monthlyChart) window.monthlyChart.destroy();
      
      window.monthlyChart = new Chart(ctxMonthly, {
        type: 'line',
        data: {
          labels: historico?.mensal?.map(item => item.mes) || [],
          datasets: [{
            label: 'Vendas Mensais',
            data: historico?.mensal?.map(item => item.total) || [],
            borderColor: '#f72585',
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatMoney(value);
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
