<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Vendas</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
  <style>
    :root { --primary:#4361ee; --secondary:#3f37c9; --success:#4cc9f0; --danger:#f72585; --light:#f8f9fa; --dark:#212529; }
    body { font-family:'Segoe UI',sans-serif; background:#f5f7fa; margin:0; color:#333; }
    .dashboard { display:grid; grid-template-columns:250px 1fr; min-height:100vh; }
    .sidebar { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; padding:20px; box-shadow:2px 0 10px rgba(0,0,0,0.1); }
    .logo { font-size:1.5rem; font-weight:bold; margin-bottom:30px; display:flex; align-items:center; gap:10px; }
    .nav-menu { list-style:none; padding:0; }
    .nav-menu li { margin-bottom:15px; }
    .nav-menu a { color:white; text-decoration:none; display:flex; align-items:center; gap:10px; padding:10px; border-radius:5px; transition:all .3s; }
    .nav-menu a:hover, .nav-menu a.active { background:rgba(255,255,255,0.2); }
    .main-content { padding:20px; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; }
    .page-title { font-size:1.8rem; font-weight:600; }
    .filters { display:flex; gap:15px; }
    .filter-group label { display:block; margin-bottom:5px; font-weight:500; font-size:.9rem; }
    select, input { padding:8px 15px; border-radius:5px; border:1px solid #ddd; background:white; }
    .cards-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:20px; margin-bottom:30px; }
    .card { background:white; border-radius:10px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); transition:transform .3s,box-shadow .3s; }
    .card:hover { transform:translateY(-5px); box-shadow:0 10px 15px rgba(0,0,0,0.1); }
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .card-title { font-size:1rem; color:#666; font-weight:500; }
    .card-icon { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; }
    .sales { background:var(--primary); } .orders { background:var(--danger); } .revenue { background:#ff9f1c; } .clients { background:var(--success); }
    .card-value { font-size:1.8rem; font-weight:700; margin-bottom:5px; }
    .card-change { display:flex; align-items:center; font-size:.9rem; }
    .card-change.positive { color:#2ecc71; } .card-change.negative { color:#e74c3c; }
    .charts-container { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px; }
    .chart-card { background:white; border-radius:10px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
    .chart-title { font-size:1.2rem; margin-bottom:20px; font-weight:600; }
    .clients-table { background:white; border-radius:10px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px 15px; text-align:left; border-bottom:1px solid #eee; }
    th { font-weight:600; color:#555; } tr:hover { background:#f9f9f9; }
    .loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(0,0,0,.1); border-radius:50%; border-top-color:var(--primary); animation:spin 1s ease-in-out infinite; margin-left:10px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    @media(max-width:992px){ .dashboard{grid-template-columns:1fr;} .sidebar{display:none;} .charts-container{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="sidebar">
      <div class="logo"><i class="fas fa-chart-line"></i> SalesDash</div>
      <ul class="nav-menu">
        <li><a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="#"><i class="fas fa-users"></i> Clientes</a></li>
        <li><a href="#"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
        <li><a href="#"><i class="fas fa-box-open"></i> Produtos</a></li>
        <li><a href="#"><i class="fas fa-chart-pie"></i> Relatórios</a></li>
        <li><a href="#"><i class="fas fa-cog"></i> Configurações</a></li>
      </ul>
    </div>
    <div class="main-content">
      <div class="header">
        <h1 class="page-title">Dashboard de Vendas <span id="loading-indicator" class="loading" style="display:none;"></span></h1>
        <div class="filters">
          <div class="filter-group">
            <label for="date-range">Período</label>
            <input type="text" id="date-range" class="date-picker" placeholder="Selecione o período">
          </div>
          <div class="filter-group">
            <label for="client-filter">Cliente</label>
            <select id="client-filter"><option value="all">Todos</option></select>
          </div>
        </div>
      </div>
      <div class="cards-container">
        <div class="card">
          <div class="card-header"><span class="card-title">Vendas Hoje</span><div class="card-icon sales"><i class="fas fa-dollar-sign"></i></div></div>
          <div id="vendas-hoje" class="card-value">R$ 0,00</div>
          <div id="change-hoje" class="card-change">—</div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Pedidos Hoje</span><div class="card-icon orders"><i class="fas fa-shopping-bag"></i></div></div>
          <div id="pedidos-hoje" class="card-value">0</div>
          <div id="change-pedidos" class="card-change">—</div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Produto Mais Vendido</span><div class="card-icon revenue"><i class="fas fa-chart-line"></i></div></div>
          <div id="mais-vendido" class="card-value">—</div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Receita Mensal</span><div class="card-icon clients"><i class="fas fa-calendar-alt"></i></div></div>
          <div id="receita-mes" class="card-value">R$ 0,00</div>
          <div id="change-mes" class="card-change">—</div>
        </div>
      </div>
      <div class="charts-container">
        <div class="chart-card"><h3 class="chart-title">Vendas Diárias (Últimos 7 dias)</h3><canvas id="dailySalesChart"></canvas></div>
        <div class="chart-card"><h3 class="chart-title">Vendas Mensais (Últimos 6 meses)</h3><canvas id="monthlySalesChart"></canvas></div>
      </div>
      <div class="clients-table">
        <h3 class="chart-title">Top Clientes</h3>
        <table>
          <thead><tr><th>Cliente</th><th>Total Gasto</th><th>Último Pedido</th><th>Contato</th></tr></thead>
          <tbody id="top-clientes"></tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    // Configuração do date picker
    flatpickr("#date-range", {
      mode: "range",
      dateFormat: "d/m/Y",
      defaultDate: [new Date().setDate(new Date().getDate()-7), new Date()]
    });

    // Configuração da sua planilha do Google Sheets
    const SHEET_ID = '2PACX-1vSjVHrLe1BOGqHZC9O2o1FxjWZluP8UCK6ZdcJSxcQRKIv1uJkO2NMKsrDdaTBg1fTS-XCwTq4RZzIb';
    const GID_PEDIDOS = '1411128451';
    const GID_RESUMO = '2133154168';
    
    // Função para construir a URL da API do Google Visualization
    function buildGVizURL(gid, query) {
      return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${gid}&tqx=out:json&tq=${encodeURIComponent(query)}`;
    }
    
    // Função para parsear a resposta do Google Visualization
    function parseGVizResponse(responseText) {
      try {
        // Remove o prefixo e sufixo que o Google adiciona
        const jsonStart = responseText.indexOf('{');
        const jsonEnd = responseText.lastIndexOf('}') + 1;
        const jsonText = responseText.substring(jsonStart, jsonEnd);
        
        // Parseia o JSON
        const data = JSON.parse(jsonText);
        
        // Verifica se a estrutura está correta
        if (!data || !data.table || !data.table.rows) {
          throw new Error('Estrutura de dados inválida');
        }
        
        return data.table.rows;
      } catch (error) {
        console.error('Erro ao parsear resposta:', error);
        throw new Error('Falha ao processar os dados da planilha');
      }
    }
    
    // Função para formatar valores monetários
    function formatMoney(value) {
      if (typeof value === 'string' && value.startsWith('R$')) {
        return value; // Já está formatado
      }
      
      const num = typeof value === 'number' ? value : parseFloat(value) || 0;
      return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    // Função para mostrar variação com ícone
    function renderVariation(value) {
      if (value === undefined || value === null || isNaN(value)) {
        return '<span>—</span>';
      }
      
      const isPositive = value >= 0;
      const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
      const colorClass = isPositive ? 'positive' : 'negative';
      
      return `
        <span class="${colorClass}">
          <i class="fas ${icon}"></i> ${Math.abs(value).toFixed(1)}%
        </span>
      `;
    }
    
    // Função para formatar data
    function formatDate(dateString) {
      if (!dateString) return '—';
      
      // Se já estiver no formato dd/mm/yyyy
      if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        return dateString;
      }
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        
        return date.toLocaleDateString('pt-BR');
      } catch {
        return dateString;
      }
    }
    
    // Função para formatar telefone
    function formatPhone(phone) {
      if (!phone) return '—';
      
      const cleaned = phone.toString().replace(/\D/g, '');
      
      if (cleaned.length === 11) {
        return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      } else if (cleaned.length === 10) {
        return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
      }
      
      return phone;
    }
    
    // Função para buscar dados do resumo
    async function fetchResumo() {
      try {
        const response = await fetch(buildGVizURL(GID_RESUMO, 'SELECT A,B,C,D OFFSET 1 LIMIT 1'));
        if (!response.ok) throw new Error('Falha na requisição');
        
        const text = await response.text();
        const rows = parseGVizResponse(text);
        
        if (!rows || rows.length === 0) {
          throw new Error('Nenhum dado encontrado na planilha de resumo');
        }
        
        const cells = rows[0].c;
        
        return {
          totalVendas: cells[0]?.v || 0,
          numeroPedidos: cells[1]?.v || 0,
          totalProdutos: cells[2]?.v || 0,
          produtoMaisVendido: cells[3]?.v || '—',
          variacaoVendas: cells[4]?.v || null,
          variacaoPedidos: cells[5]?.v || null,
          variacaoMensal: cells[6]?.v || null
        };
      } catch (error) {
        console.error('Erro ao buscar resumo:', error);
        return {
          totalVendas: 0,
          numeroPedidos: 0,
          totalProdutos: 0,
          produtoMaisVendido: '—',
          variacaoVendas: null,
          variacaoPedidos: null,
          variacaoMensal: null
        };
      }
    }
    
    // Função para buscar top clientes
    async function fetchTopClientes() {
      try {
        const response = await fetch(buildGVizURL(GID_RESUMO, 'SELECT A,B,C,D OFFSET 4 LIMIT 3'));
        if (!response.ok) throw new Error('Falha na requisição');
        
        const text = await response.text();
        const rows = parseGVizResponse(text);
        
        if (!rows || rows.length === 0) {
          console.warn('Nenhum cliente encontrado na planilha');
          return [];
        }
        
        return rows.map(row => ({
          nome: row.c[0]?.v || '—',
          totalGasto: row.c[1]?.v || '—',
          ultimoPedido: row.c[2]?.v || '—',
          whatsapp: row.c[3]?.v ? row.c[3].v.toString().replace(/\D/g, '') : ''
        }));
      } catch (error) {
        console.error('Erro ao buscar clientes:', error);
        return [];
      }
    }
    
    // Função para buscar histórico diário
    async function fetchHistoricoDiario() {
      try {
        const response = await fetch(buildGVizURL(GID_PEDIDOS, 'SELECT F,SUM(B),SUM(C) WHERE F IS NOT NULL GROUP BY F ORDER BY F DESC LIMIT 7'));
        if (!response.ok) throw new Error('Falha na requisição');
        
        const text = await response.text();
        const rows = parseGVizResponse(text);
        
        if (!rows || rows.length === 0) {
          console.warn('Nenhum dado de histórico diário encontrado');
          return [];
        }
        
        return rows.map(row => ({
          data: row.c[0]?.v ? row.c[0].v.split(' ')[0] : '—',
          pedidos: row.c[1]?.v || 0,
          vendas: parseFloat(row.c[2]?.v) || 0
        })).reverse(); // Inverte para ordem cronológica
      } catch (error) {
        console.error('Erro ao buscar histórico diário:', error);
        return [];
      }
    }
    
    // Função para buscar histórico mensal
    async function fetchHistoricoMensal() {
      try {
        const response = await fetch(buildGVizURL(GID_PEDIDOS, 'SELECT LEFT(F,7),SUM(C) WHERE F IS NOT NULL GROUP BY LEFT(F,7) ORDER BY LEFT(F,7) DESC LIMIT 6'));
        if (!response.ok) throw new Error('Falha na requisição');
        
        const text = await response.text();
        const rows = parseGVizResponse(text);
        
        if (!rows || rows.length === 0) {
          console.warn('Nenhum dado de histórico mensal encontrado');
          return [];
        }
        
        return rows.map(row => ({
          mes: row.c[0]?.v || '—',
          vendas: parseFloat(row.c[1]?.v) || 0
        })).reverse(); // Inverte para ordem cronológica
      } catch (error) {
        console.error('Erro ao buscar histórico mensal:', error);
        return [];
      }
    }
    
    // Atualiza os gráficos
    function updateCharts(dailyData, monthlyData) {
      // Gráfico de vendas diárias
      const ctxD = document.getElementById('dailySalesChart').getContext('2d');
      if (window.dailyChart) window.dailyChart.destroy();
      
      window.dailyChart = new Chart(ctxD, {
        type: 'bar',
        data: {
          labels: dailyData.map(d => formatDate(d.data)),
          datasets: [{
            label: 'Vendas (R$)',
            data: dailyData.map(d => d.vendas),
            backgroundColor: '#4361ee',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatMoney(value);
                }
              }
            }
          }
        }
      });
      
      // Gráfico de vendas mensais
      const ctxM = document.getElementById('monthlySalesChart').getContext('2d');
      if (window.monthlyChart) window.monthlyChart.destroy();
      
      window.monthlyChart = new Chart(ctxM, {
        type: 'line',
        data: {
          labels: monthlyData.map(m => m.mes),
          datasets: [{
            label: 'Vendas (R$)',
            data: monthlyData.map(m => m.vendas),
            fill: false,
            borderColor: '#f72585',
            tension: 0.3,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return formatMoney(value);
                }
              }
            }
          }
        }
      });
    }
    
    // Carrega os dados do dashboard
    async function loadDashboardData() {
      try {
        // Mostra indicador de carregamento
        document.getElementById('loading-indicator').style.display = 'inline-block';
        
        // Busca todos os dados em paralelo
        const [resumo, topClientes, historicoDiario, historicoMensal] = await Promise.all([
          fetchResumo(),
          fetchTopClientes(),
          fetchHistoricoDiario(),
          fetchHistoricoMensal()
        ]);
        
        // Atualiza os cards
        document.getElementById('vendas-hoje').textContent = formatMoney(resumo.totalVendas);
        document.getElementById('pedidos-hoje').textContent = resumo.numeroPedidos;
        document.getElementById('mais-vendido').textContent = resumo.produtoMaisVendido;
        document.getElementById('receita-mes').textContent = formatMoney(resumo.totalVendas);
        
        // Atualiza as variações
        document.getElementById('change-hoje').innerHTML = renderVariation(resumo.variacaoVendas);
        document.getElementById('change-pedidos').innerHTML = renderVariation(resumo.variacaoPedidos);
        document.getElementById('change-mes').innerHTML = renderVariation(resumo.variacaoMensal);
        
        // Atualiza a tabela de clientes
        const tb = document.getElementById('top-clientes');
        tb.innerHTML = '';
        
        topClientes.forEach(cliente => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${cliente.nome}</td>
            <td>${typeof cliente.totalGasto === 'number' ? formatMoney(cliente.totalGasto) : cliente.totalGasto}</td>
            <td>${formatDate(cliente.ultimoPedido)}</td>
            <td>${
              cliente.whatsapp 
                ? `<a href="https://wa.me/${cliente.whatsapp}" target="_blank"><i class="fab fa-whatsapp"></i> ${formatPhone(cliente.whatsapp)}</a>`
                : '—'
            }</td>
          `;
          tb.appendChild(tr);
        });
        
        // Atualiza os gráficos
        updateCharts(historicoDiario, historicoMensal);
        
      } catch (error) {
        console.error('Erro ao carregar dashboard:', error);
        alert('Erro ao carregar dados. Verifique o console para mais detalhes.');
      } finally {
        // Esconde indicador de carregamento
        document.getElementById('loading-indicator').style.display = 'none';
      }
    }
    
    // Carrega o dashboard quando a página estiver pronta
    document.addEventListener('DOMContentLoaded', loadDashboardData);
    
    // Atualiza ao mudar o período
    document.getElementById('date-range').addEventListener('change', loadDashboardData);
  </script>
</body>
</html>