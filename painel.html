<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Pedidos</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- jsPDF + html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f4f4f4;
      color: #333;
    }
    header {
      background: #2c3e50;
      color: white; padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .metric {
      flex: 1;
      min-width: 150px;
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .metric h2 {
      margin: 0;
      font-size: 2rem;
      color: #27ae60;
    }
    .metric p {
      margin: .5rem 0 0;
      color: #555;
    }
    .chart-container {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    #btn-pdf {
      display: block;
      margin: 1rem auto 3rem;
      padding: .75rem 2rem;
      background: #27ae60;
      color: white;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #btn-pdf:hover {
      background: #219150;
    }
  </style>
</head>
<body>
  <header>
    <h1>Dashboard de Pedidos</h1>
  </header>
  <div class="container" id="dashboard">
    <div class="metrics" id="metrics"></div>

    <div class="chart-container">
      <canvas id="chart-date"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chart-top"></canvas>
    </div>

    <button id="btn-pdf">ðŸ“„ Baixar PDF</button>
  </div>

  <script>
    // URLs CSV
    const ORDERS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjVHrLe1BOGqHZC9O2o1FxjWZluP8UCK6ZdcJSxcQRKIv1uJkO2NMKsrDdaTBg1fTS-XCwTq4RZzIb/pub?gid=1411128451&single=true&output=csv";
    const SUMMARY_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjVHrLe1BOGqHZC9O2o1FxjWZluP8UCK6ZdcJSxcQRKIv1uJkO2NMKsrDdaTBg1fTS-XCwTq4RZzIb/pub?gid=2133154168&single=true&output=csv";

    // Carregar e parsear CSV
    async function fetchCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return Papa.parse(text, { header: true, dynamicTyping: true }).data;
    }

    // InicializaÃ§Ã£o
    Promise.all([fetchCSV(ORDERS_URL), fetchCSV(SUMMARY_URL)])
      .then(([orders, summary]) => {
        // â†’ MÃ©tricas
        const metricsEl = document.getElementById("metrics");
        const summaryRow = summary[0];
        for (let key in summaryRow) {
          const card = document.createElement("div");
          card.classList.add("metric");
          card.innerHTML = `
            <h2>${summaryRow[key]}</h2>
            <p>${key}</p>
          `;
          metricsEl.appendChild(card);
        }

        // â†’ GrÃ¡fico Pedidos por Data
        const byDate = {};
        orders.forEach(o => {
          const d = new Date(o.Data).toLocaleDateString("pt-BR");
          byDate[d] = (byDate[d]||0) + o.Quantidade;
        });
        const labelsDate = Object.keys(byDate).sort((a,b) => {
          const da = new Date(a.split("/").reverse().join("-"));
          const db = new Date(b.split("/").reverse().join("-"));
          return da - db;
        });
        const dataDate = labelsDate.map(d => byDate[d]);
        new Chart(document.getElementById("chart-date"), {
          type: 'line',
          data: {
            labels: labelsDate,
            datasets: [{ label: 'Pedidos', data: dataDate, fill:false, tension:0.1 }]
          },
          options: { responsive:true }
        });

        // â†’ GrÃ¡fico Top 10 Produtos
        const byProd = {};
        orders.forEach(o => {
          byProd[o.Produto] = (byProd[o.Produto]||0) + o.Quantidade;
        });
        const sorted = Object.entries(byProd)
          .sort((a,b) => b[1] - a[1])
          .slice(0,10)
          .reverse();
        const prodLabels = sorted.map(x => x[0]);
        const prodData = sorted.map(x => x[1]);
        new Chart(document.getElementById("chart-top"), {
          type: 'bar',
          data: {
            labels: prodLabels,
            datasets: [{ label: 'Qtd. Vendida', data: prodData }]
          },
          options: {
            indexAxis: 'y',
            responsive:true
          }
        });
      });

    // PDF
    document.getElementById("btn-pdf").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      html2canvas(document.getElementById("dashboard"), { scale: 2 })
        .then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
          const imgProps = pdf.getImageProperties(imgData);
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          pdf.save('relatorio_pedidos.pdf');
        });
    });
  </script>
</body>
</html>
